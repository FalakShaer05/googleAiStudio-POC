<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compositing - AI Image Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .composite-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .preview-section {
            padding: 2rem;
            background: #f8f9fa;
        }
        
        .image-preview {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .controls-section {
            padding: 2rem;
            background: white;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-range {
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
        }
        
        .form-range::-webkit-slider-thumb {
            background: #667eea;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }
        
        .btn-composite {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-composite:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .value-display {
            background: #e9ecef;
            border-radius: 20px;
            padding: 5px 15px;
            font-weight: 600;
            color: #495057;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        
        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .position-btn {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .position-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .position-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="composite-container">
            <div class="header">
                <h1><i class="fas fa-layer-group me-3"></i>Image Compositing</h1>
                <p class="mb-0">Position and adjust your converted image on the background</p>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="preview-section">
                        <h4><i class="fas fa-eye me-2"></i>Preview</h4>
                        <div class="image-preview" id="previewContainer">
                            <div class="loading-overlay" id="loadingOverlay">
                                <div class="spinner"></div>
                            </div>
                            <div id="previewContent">
                                <p class="text-muted">Loading images...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="controls-section">
                        <h4><i class="fas fa-sliders-h me-2"></i>Controls</h4>
                        
                        <!-- Position Control -->
                        <div class="control-group">
                            <label class="form-label">Position</label>
                            <div class="position-grid">
                                <div class="position-btn" data-position="top-left">↖</div>
                                <div class="position-btn" data-position="top">↑</div>
                                <div class="position-btn" data-position="top-right">↗</div>
                                <div class="position-btn" data-position="left">←</div>
                                <div class="position-btn active" data-position="center">⊙</div>
                                <div class="position-btn" data-position="right">→</div>
                                <div class="position-btn" data-position="bottom-left">↙</div>
                                <div class="position-btn" data-position="bottom">↓</div>
                                <div class="position-btn" data-position="bottom-right">↘</div>
                            </div>
                        </div>
                        
                        <!-- Scale Control -->
                        <div class="control-group">
                            <label class="form-label">Scale</label>
                            <input type="range" class="form-range" id="scaleSlider" min="0.1" max="3.0" step="0.1" value="1.0">
                            <div class="mt-2">
                                <span class="value-display" id="scaleValue">1.0x</span>
                            </div>
                        </div>
                        
                        <!-- Opacity Control -->
                        <div class="control-group">
                            <label class="form-label">Opacity</label>
                            <input type="range" class="form-range" id="opacitySlider" min="0.0" max="1.0" step="0.1" value="1.0">
                            <div class="mt-2">
                                <span class="value-display" id="opacityValue">100%</span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-composite" id="compositeBtn">
                                <i class="fas fa-magic me-2"></i>Create Final Image
                            </button>
                            <button class="btn btn-download" id="downloadBtn" style="display: none;">
                                <i class="fas fa-download me-2"></i>Download Result
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const convertedFilename = urlParams.get('converted');
        const backgroundFilename = urlParams.get('background');
        
        // State
        let currentPosition = 'center';
        let currentScale = 1.0;
        let currentOpacity = 1.0;
        let convertedImage = null;
        let backgroundImage = null;
        let finalImageFilename = null;
        
        // DOM elements
        const previewContainer = document.getElementById('previewContainer');
        const previewContent = document.getElementById('previewContent');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const scaleSlider = document.getElementById('scaleSlider');
        const opacitySlider = document.getElementById('opacitySlider');
        const scaleValue = document.getElementById('scaleValue');
        const opacityValue = document.getElementById('opacityValue');
        const compositeBtn = document.getElementById('compositeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const positionBtns = document.querySelectorAll('.position-btn');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Composite page loaded');
            console.log('Converted filename:', convertedFilename);
            console.log('Background filename:', backgroundFilename);
            
            if (!convertedFilename || !backgroundFilename) {
                console.error('Missing image parameters');
                alert('Missing image parameters');
                window.location.href = '/';
                return;
            }
            
            // Validate filename lengths (some browsers have URL length limits)
            if (convertedFilename.length > 200 || backgroundFilename.length > 200) {
                console.warn('Very long filenames detected:', {
                    converted: convertedFilename.length,
                    background: backgroundFilename.length
                });
            }
            
            // Add a small delay to ensure DOM is fully ready
            setTimeout(() => {
                loadImages();
                setupEventListeners();
            }, 100);
        });
        
        function loadImages() {
            showLoading(true);
            
            let loadedCount = 0;
            const totalImages = 2;
            let hasError = false;
            
            // Set a timeout to prevent infinite loading
            const loadingTimeout = setTimeout(() => {
                if (loadedCount < totalImages && !hasError) {
                    console.error('Image loading timeout after 30 seconds');
                    showLoading(false);
                    previewContent.innerHTML = '<p class="text-danger">Timeout loading images. Please refresh the page and try again.</p>';
                }
            }, 30000); // 30 second timeout
            
            function checkAllLoaded() {
                loadedCount++;
                console.log(`Images loaded: ${loadedCount}/${totalImages}`);
                if (loadedCount === totalImages) {
                    clearTimeout(loadingTimeout);
                    updatePreview();
                }
            }
            
            // Load converted image
            const convertedImg = new Image();
            convertedImg.onload = function() {
                console.log('Converted image loaded successfully:', convertedImg.src);
                console.log('Converted image dimensions:', convertedImg.width, 'x', convertedImg.height);
                convertedImage = convertedImg;
                checkAllLoaded();
            };
            convertedImg.onloadstart = function() {
                console.log('Started loading converted image...');
            };
            convertedImg.onerror = function() {
                console.error('Failed to load converted image:', convertedImg.src);
                hasError = true;
                clearTimeout(loadingTimeout);
                showLoading(false);
                previewContent.innerHTML = '<p class="text-danger">Error loading converted image. Please check the file path.</p>';
            };
            console.log('Loading converted image from:', `/outputs/${convertedFilename}`);
            convertedImg.src = `/outputs/${convertedFilename}`;
            
            // Load background image
            const backgroundImg = new Image();
            backgroundImg.onload = function() {
                console.log('Background image loaded successfully:', backgroundImg.src);
                console.log('Background image dimensions:', backgroundImg.width, 'x', backgroundImg.height);
                backgroundImage = backgroundImg;
                checkAllLoaded();
            };
            backgroundImg.onloadstart = function() {
                console.log('Started loading background image...');
            };
            backgroundImg.onerror = function() {
                console.error('Failed to load background image:', backgroundImg.src);
                hasError = true;
                clearTimeout(loadingTimeout);
                showLoading(false);
                previewContent.innerHTML = '<p class="text-danger">Error loading background image. Please check the file path.</p>';
            };
            console.log('Loading background image from:', `/uploads/${backgroundFilename}`);
            backgroundImg.src = `/uploads/${backgroundFilename}`;
        }
        
        function removeWhiteBackground(imageData, threshold = 240) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Create a mask to track which pixels to remove
            const mask = new Array(width * height).fill(false);
            const visited = new Array(width * height).fill(false);
            
            // Flood fill from edges to find background
            const queue = [];
            
            // Add edge pixels to queue
            for (let x = 0; x < width; x++) {
                queue.push({x, y: 0});
                queue.push({x, y: height - 1});
            }
            for (let y = 0; y < height; y++) {
                queue.push({x: 0, y});
                queue.push({x: width - 1, y});
            }
            
            // Flood fill algorithm
            while (queue.length > 0) {
                const {x, y} = queue.shift();
                const index = y * width + x;
                
                if (x < 0 || x >= width || y < 0 || y >= height || visited[index]) {
                    continue;
                }
                
                const pixelIndex = index * 4;
                const r = data[pixelIndex];
                const g = data[pixelIndex + 1];
                const b = data[pixelIndex + 2];
                
                // Check if pixel is white or near white (background)
                if (r > threshold && g > threshold && b > threshold) {
                    mask[index] = true;
                    visited[index] = true;
                    
                    // Add neighbors to queue
                    queue.push({x: x + 1, y});
                    queue.push({x: x - 1, y});
                    queue.push({x, y: y + 1});
                    queue.push({x, y: y - 1});
                }
            }
            
            // Apply mask to make background transparent
            for (let i = 0; i < data.length; i += 4) {
                const pixelIndex = i / 4;
                if (mask[pixelIndex]) {
                    data[i + 3] = 0; // Make transparent
                }
            }
            
            return imageData;
        }
        
        function updatePreview() {
            if (!convertedImage || !backgroundImage) {
                console.log('Cannot update preview - missing images:', {
                    convertedImage: !!convertedImage,
                    backgroundImage: !!backgroundImage
                });
                return;
            }
            
            console.log('Updating preview with images:', {
                converted: { width: convertedImage.width, height: convertedImage.height },
                background: { width: backgroundImage.width, height: backgroundImage.height },
                position: currentPosition,
                scale: currentScale,
                opacity: currentOpacity
            });
            
            showLoading(false);
            
            // Create preview canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate preview size (max 800px to prevent overflow)
            const maxPreviewSize = 800;
            const bgAspectRatio = backgroundImage.width / backgroundImage.height;
            
            let previewWidth, previewHeight;
            if (backgroundImage.width > backgroundImage.height) {
                previewWidth = Math.min(backgroundImage.width, maxPreviewSize);
                previewHeight = previewWidth / bgAspectRatio;
            } else {
                previewHeight = Math.min(backgroundImage.height, maxPreviewSize);
                previewWidth = previewHeight * bgAspectRatio;
            }
            
            // Set canvas size for preview
            canvas.width = previewWidth;
            canvas.height = previewHeight;
            
            // Draw background (scaled to fit preview)
            ctx.drawImage(backgroundImage, 0, 0, previewWidth, previewHeight);
            
            // Calculate scale factor for converted image relative to preview
            const previewScale = previewWidth / backgroundImage.width;
            
            // Calculate converted image position and size
            const scale = currentScale;
            const scaledWidth = (convertedImage.width * scale) * previewScale;
            const scaledHeight = (convertedImage.height * scale) * previewScale;
            
            // Calculate position
            let x, y;
            switch (currentPosition) {
                case 'top-left': x = 0; y = 0; break;
                case 'top': x = (previewWidth - scaledWidth) / 2; y = 0; break;
                case 'top-right': x = previewWidth - scaledWidth; y = 0; break;
                case 'left': x = 0; y = (previewHeight - scaledHeight) / 2; break;
                case 'center': x = (previewWidth - scaledWidth) / 2; y = (previewHeight - scaledHeight) / 2; break;
                case 'right': x = previewWidth - scaledWidth; y = (previewHeight - scaledHeight) / 2; break;
                case 'bottom-left': x = 0; y = previewHeight - scaledHeight; break;
                case 'bottom': x = (previewWidth - scaledWidth) / 2; y = previewHeight - scaledHeight; break;
                case 'bottom-right': x = previewWidth - scaledWidth; y = previewHeight - scaledHeight; break;
            }
            
            // Create a temporary canvas for the converted image with white background removal
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = scaledWidth;
            tempCanvas.height = scaledHeight;
            
            // Draw converted image to temp canvas (scaled)
            tempCtx.drawImage(convertedImage, 0, 0, scaledWidth, scaledHeight);
            
            // Get image data and remove white background
            const imageData = tempCtx.getImageData(0, 0, scaledWidth, scaledHeight);
            const processedImageData = removeWhiteBackground(imageData);
            tempCtx.putImageData(processedImageData, 0, 0);
            
            // Apply opacity
            ctx.globalAlpha = currentOpacity;
            
            // Draw processed converted image
            ctx.drawImage(tempCanvas, x, y);
            
            // Reset opacity
            ctx.globalAlpha = 1.0;
            
            // Update preview
            previewContent.innerHTML = '';
            const previewImg = document.createElement('img');
            previewImg.src = canvas.toDataURL();
            previewImg.className = 'preview-image';
            previewContent.appendChild(previewImg);
            
            console.log('Preview updated successfully with canvas size:', canvas.width, 'x', canvas.height);
        }
        
        function setupEventListeners() {
            // Position buttons
            positionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    positionBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPosition = this.dataset.position;
                    updatePreview();
                });
            });
            
            // Scale slider
            scaleSlider.addEventListener('input', function() {
                currentScale = parseFloat(this.value);
                scaleValue.textContent = currentScale.toFixed(1) + 'x';
                updatePreview();
            });
            
            // Opacity slider
            opacitySlider.addEventListener('input', function() {
                currentOpacity = parseFloat(this.value);
                opacityValue.textContent = Math.round(currentOpacity * 100) + '%';
                updatePreview();
            });
            
            // Composite button
            compositeBtn.addEventListener('click', function() {
                createFinalImage();
            });
            
            // Download button
            downloadBtn.addEventListener('click', function() {
                if (finalImageFilename) {
                    window.location.href = `/download/${finalImageFilename}`;
                }
            });
        }
        
        function createFinalImage() {
            showLoading(true);
            compositeBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('converted_filename', convertedFilename);
            formData.append('reference_background_filename', backgroundFilename);
            formData.append('position', currentPosition);
            formData.append('scale', currentScale.toString());
            formData.append('opacity', currentOpacity.toString());
            
            fetch('/composite', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                compositeBtn.disabled = false;
                
                if (data.success) {
                    finalImageFilename = data.output_filename;
                    downloadBtn.style.display = 'block';
                    compositeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Completed!';
                    compositeBtn.classList.remove('btn-composite');
                    compositeBtn.classList.add('btn-success');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                compositeBtn.disabled = false;
                alert('Error: ' + error.message);
            });
        }
        
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
